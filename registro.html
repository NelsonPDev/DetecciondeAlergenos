<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - Detección de Alergenos</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="auth-body">
    <div class="login-wrapper">
        <div class="login-image-panel">
            <div class="image-content">
                <h2>Crea tu Cuenta</h2>
                <p>Únete y mantén un control de tus alérgenos.</p>
            </div>
        </div>
        <div class="login-form-panel">
            <div class="auth-card" style="width: 600px; max-width: 100%;">
                <div class="progress-bar-container">
                    <div class="progress-bar">
                        <div class="progress-line"></div>
                        <div class="step active" data-step="1">
                            <div class="step-icon">1</div>
                            <div class="step-label">Personal</div>
                        </div>
                        <div class="step" data-step="2">
                            <div class="step-icon">2</div>
                            <div class="step-label">Alérgenos</div>
                        </div>
                        <div class="step" data-step="3">
                            <div class="step-icon">3</div>
                            <div class="step-label">Contraseña</div>
                        </div>
                        <div class="step" data-step="4">
                            <div class="step-icon">4</div>
                            <div class="step-label">Confirmar</div>
                        </div>
                    </div>
                </div>

                <div id="mensajeError" class="mensaje-error" style="display: none;"></div>
                <div id="mensajeExito" class="mensaje-exito" style="display: none;"></div>

                <form id="formularioRegistro" onsubmit="registrarUsuario(event)" novalidate>
                    <!-- Step 1: Personal Info -->
                    <div class="form-step active" id="step-1">
                        <div class="dos-columnas">
                            <div class="form-group">
                                <label for="nombre">Nombre</label>
                                <input type="text" id="nombre" name="nombre" required placeholder="">
                                <div class="error-message" id="errorNombre"></div>
                            </div>

                            <div class="form-group">
                                <label for="fechaNacimiento">Fecha de Nacimiento</label>
                                <input type="date" id="fechaNacimiento" name="fecha_nacimiento" required>
                                <div class="error-message" id="errorFechaNacimiento"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="email">Correo Electrónico</label>
                            <input type="email" id="email" name="email" required placeholder="">
                            <div class="error-message" id="errorEmail"></div>
                        </div>
                        <div class="navigation-buttons">
                            <button type="button" class="next-btn auth-button" style="width: auto;">Siguiente</button>
                        </div>
                    </div>

                    <!-- Step 2: Allergens -->
                    <div class="form-step" id="step-2">
                        <div class="form-group">
                            <label>Selecciona tus Alérgenos (Opcional)</label>
                            <div id="alergenos-comunes-container" style="max-height: 200px; overflow-y: auto; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <!-- Alérgenos cargados dinámicamente -->
                            </div>
                        </div>
                        <div class="navigation-buttons">
                            <button type="button" class="prev-btn auth-button" style="width: auto;">Anterior</button>
                            <button type="button" class="next-btn auth-button" style="width: auto;">Siguiente</button>
                        </div>
                    </div>

                    <!-- Step 3: Password -->
                    <div class="form-step" id="step-3">
                        <div class="requisitos">
                            <strong>Requisitos de contraseña:</strong>
                            <ul style="margin: 8px 0 0 20px; padding: 0;">
                                <li>Mínimo 6 caracteres</li>
                                <li>Incluir al menos una mayúscula</li>
                                <li>Incluir al menos un número</li>
                            </ul>
                        </div>
                        <div class="form-group">
                            <label for="password">Contraseña</label>
                            <input type="password" id="password" name="password" required placeholder="Crea una contraseña segura">
                            <div class="error-message" id="errorPassword"></div>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirmar Contraseña</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Confirma tu contraseña">
                            <div class="error-message" id="errorConfirmPassword"></div>
                        </div>
                        <div class="navigation-buttons">
                            <button type="button" class="prev-btn auth-button" style="width: auto;">Anterior</button>
                            <button type="button" class="next-btn auth-button" style="width: auto;">Siguiente</button>
                        </div>
                    </div>
                    
                    <!-- Step 4: Confirmation -->
                    <div class="form-step" id="step-4">
                        <div class="confirmation">
                            <p>Revisa tu información antes de confirmar.</p>
                            <div id="confirmation-details"></div>
                        </div>
                        <div class="navigation-buttons">
                            <button type="button" class="prev-btn auth-button" style="width: auto;">Anterior</button>
                            <button type="submit" class="auth-button" style="width: auto;">✓ Crear Cuenta</button>
                        </div>
                    </div>
                </form>

                <div class="auth-link">
                    <p>¿Ya tienes una cuenta?</p>
                    <a href="login.html">Inicia sesión aquí</a>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const steps = Array.from(document.querySelectorAll('.form-step'));
            const nextButtons = document.querySelectorAll('.next-btn');
            const prevButtons = document.querySelectorAll('.prev-btn');
            const progressBar = document.querySelector('.progress-bar');
            const progressLine = document.querySelector('.progress-line');
            const progressBarSteps = document.querySelectorAll('.progress-bar .step');
            
            let currentStep = 0;

            const updateDisplay = () => {
                // Actualizar campos de formulario
                steps.forEach((step, index) => {
                    step.classList.toggle('active', index === currentStep);
                });

                // Actualizar barra de progreso
                progressBarSteps.forEach((pStep, index) => {
                    if (index < currentStep) {
                        pStep.classList.add('completed');
                        pStep.classList.remove('active');
                    } else if (index === currentStep) {
                        pStep.classList.add('active');
                        pStep.classList.remove('completed');
                    } else {
                        pStep.classList.remove('active', 'completed');
                    }
                });

                // Actualizar línea de progreso
                const activeStep = progressBarSteps[currentStep];
                const completedSteps = document.querySelectorAll('.progress-bar .step.completed');
                
                let progressWidth = 0;
                if (completedSteps.length > 0) {
                    const lastCompleted = completedSteps[completedSteps.length - 1];
                    progressWidth = (lastCompleted.offsetLeft + lastCompleted.offsetWidth / 2) / progressBar.offsetWidth * 100;
                }
                
                if (currentStep > 0) {
                    progressWidth = ((currentStep) / (progressBarSteps.length - 1)) * 100;
                }


                progressLine.style.width = `${progressWidth}%`;
            };

            const validateAndGoNext = async () => {
                if (!validateStep(currentStep)) {
                    return; // Detener si la validación del cliente falla
                }

                // Verificación de correo electrónico para el primer paso
                if (currentStep === 0) {
                    const email = document.getElementById('email').value;
                    const nextButton = document.querySelector('#step-1 .next-btn');
                    nextButton.disabled = true; // Desactivar el botón
                    nextButton.textContent = 'Verificando...';

                    try {
                        const response = await fetch('api/verificar_email.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ email: email })
                        });

                        const data = await response.json();

                        if (data.existe) {
                            mostrarError('email', 'Este correo electrónico ya está registrado.');
                            nextButton.disabled = false; // Reactivar el botón
                            nextButton.textContent = 'Siguiente';
                            return; // Detener el avance
                        }
                    } catch (error) {
                        console.error('Error al verificar el email:', error);
                        mostrarError('email', 'No se pudo verificar el correo. Inténtalo de nuevo.');
                        nextButton.disabled = false; // Reactivar el botón
                        nextButton.textContent = 'Siguiente';
                        return; // Detener en caso de error
                    }
                    
                    nextButton.disabled = false; // Reactivar si todo está bien
                    nextButton.textContent = 'Siguiente';
                }

                // Avanzar al siguiente paso
                if (currentStep < steps.length - 1) {
                    currentStep++;
                    if (currentStep === steps.length - 1) {
                        showConfirmation(); // Cargar datos de confirmación
                    }
                    updateDisplay();
                }
            };

            const goPrevious = () => {
                if (currentStep > 0) {
                    currentStep--;
                    updateDisplay();
                }
            };

            nextButtons.forEach(button => button.addEventListener('click', validateAndGoNext));
            prevButtons.forEach(button => button.addEventListener('click', goPrevious));

            // Initial calls
            verificarSesionExistente();
            cargarAlergenosComunes();
            updateDisplay(); // Llamada inicial para establecer el estado
        });

        function validateStep(stepIndex) {
            limpiarErrores();
            let isValid = true;
            // Validación para el paso 0: Información Personal
            if (stepIndex === 0) {
                const nombre = document.getElementById('nombre').value;
                const email = document.getElementById('email').value;
                const fechaNacimiento = document.getElementById('fechaNacimiento').value;
                if (!validarParcial('nombre', nombre)) isValid = false;
                if (!validarParcial('email', email)) isValid = false;
                if (!validarParcial('fechaNacimiento', fechaNacimiento)) isValid = false;
            }
             // El paso 1 (Alérgenos) es opcional, no necesita validación para avanzar
            if (stepIndex === 1) {
                return true;
            }
            // Validación para el paso 2: Contraseña
            if (stepIndex === 2) {
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                if (!validarParcial('password', password)) isValid = false;
                if (!validarParcial('confirmPassword', confirmPassword, password)) isValid = false;
            }
            return isValid;
        }

        function showConfirmation() {
            const nombre = document.getElementById('nombre').value;
            const email = document.getElementById('email').value;
            const fechaNacimiento = document.getElementById('fechaNacimiento').value;
            const alergenos = Array.from(document.querySelectorAll('input[name="alergenos[]"]:checked')).map(cb => cb.parentElement.querySelector('label').innerText);

            const details = `
                <p><strong>Nombre:</strong> ${nombre || 'No proporcionado'}</p>
                <p><strong>Email:</strong> ${email || 'No proporcionado'}</p>
                <p><strong>Fecha de Nacimiento:</strong> ${fechaNacimiento || 'No proporcionado'}</p>
                <p><strong>Alérgenos:</strong> ${alergenos.length > 0 ? alergenos.join(', ') : 'Ninguno seleccionado'}</p>
            `;
            document.getElementById('confirmation-details').innerHTML = details;
        };

        function verificarSesionExistente() {
            fetch('api/verificar_sesion.php')
                .then(response => response.json())
                .then(data => {
                    if (data.logueado) {
                        window.location.href = 'dashboard.html';
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        async function cargarAlergenosComunes() {
            try {
                const response = await fetch('api/obtener_alergenos_comunes.php');
                const data = await response.json();
                const container = document.getElementById('alergenos-comunes-container');
                if (data.exito && data.alergenos.length > 0) {
                    container.innerHTML = data.alergenos.map((alergeno, index) => `
                        <div class="alergeno-checkbox">
                            <input type="checkbox" id="alergeno-${index}" name="alergenos[]" value="${alergeno.nombre}">
                            <label for="alergeno-${index}" title="${alergeno.descripcion}">${alergeno.nombre}</label>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p>No se pudieron cargar los alérgenos comunes.</p>';
                }
            } catch (error) {
                console.error('Error al cargar alérgenos comunes:', error);
                document.getElementById('alergenos-comunes-container').innerHTML = '<p>Error de conexión.</p>';
            }
        }

        async function registrarUsuario(event) {
            event.preventDefault();
            
            // Re-validar todos los pasos importantes antes de enviar
            let allStepsValid = true;
            for(let i = 0; i <= 2; i++){
                if(i === 1) continue; // Saltar el paso opcional de alérgenos
                if(!validateStep(i)){
                    allStepsValid = false;
                    // Ir al primer paso con error
                    currentStep = i;
                    updateDisplay();
                    break;
                }
            }

            if (!allStepsValid) {
                document.getElementById('mensajeError').textContent = '✗ Por favor, corrige los errores antes de continuar.';
                document.getElementById('mensajeError').style.display = 'block';
                return;
            }

            const formData = new FormData(document.getElementById('formularioRegistro'));
            const alergenosSeleccionados = Array.from(document.querySelectorAll('input[name="alergenos[]"]:checked')).map(cb => cb.value);
            formData.append('alergenos', JSON.stringify(alergenosSeleccionados));


            try {
                const response = await fetch('api/registro.php', { method: 'POST', body: formData });
                const resultado = await response.json();

                if (resultado.exito) {
                    document.getElementById('mensajeExito').textContent = '✓ ' + resultado.mensaje;
                    document.getElementById('mensajeExito').style.display = 'block';
                    document.getElementById('mensajeError').style.display = 'none';
                    setTimeout(() => { window.location.href = resultado.redirect || 'dashboard.html'; }, 2000);
                } else {
                    document.getElementById('mensajeError').textContent = '✗ ' + resultado.mensaje;
                    document.getElementById('mensajeError').style.display = 'block';
                    document.getElementById('mensajeExito').style.display = 'none';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('mensajeError').textContent = '✗ Error al procesar el registro';
                document.getElementById('mensajeError').style.display = 'block';
            }
        }
        
        function validarParcial(campo, valor, valor2) {
            let valido = true;
            if (campo === 'nombre') {
                if (valor.trim().length < 3) {
                    mostrarError('nombre', 'El nombre debe tener al menos 3 caracteres');
                    valido = false;
                }
            } else if (campo === 'email') {
                const regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!regexEmail.test(valor)) {
                    mostrarError('email', 'Correo electrónico inválido');
                    valido = false;
                }
            } else if (campo === 'fechaNacimiento') {
                if (!valor) {
                    mostrarError('fechaNacimiento', 'Debes seleccionar una fecha');
                    valido = false;
                } else {
                    const hoy = new Date();
                    const fechaNac = new Date(valor);
                    let edad = hoy.getFullYear() - fechaNac.getFullYear();
                    const m = hoy.getMonth() - fechaNac.getMonth();
                    if (m < 0 || (m === 0 && hoy.getDate() < fechaNac.getDate())) {
                        edad--;
                    }
                    if (edad < 13 || edad > 120) {
                        mostrarError('fechaNacimiento', 'Debes tener entre 13 y 120 años');
                        valido = false;
                    }
                }
            } else if (campo === 'password') {
                const regexPassword = /^(?=.*[A-Z])(?=.*\d).{6,}$/;
                if (!regexPassword.test(valor)) {
                    mostrarError('password', 'Requiere 6+ chars, 1 mayúscula y 1 número');
                    valido = false;
                }
            } else if (campo === 'confirmPassword') {
                if (valor !== valor2) {
                    mostrarError('confirmPassword', 'Las contraseñas no coinciden');
                    valido = false;
                }
            }
            return valido;
        }

        function mostrarError(campo, mensaje) {
            const elementoError = document.getElementById('error' + campo.charAt(0).toUpperCase() + campo.slice(1));
            if (elementoError) {
                elementoError.textContent = mensaje;
            }
            const inputElement = document.getElementById(campo);
            if(inputElement) {
                inputElement.style.borderColor = '#e74c3c';
            }
        }

        function limpiarErrores() {
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            document.querySelectorAll('.form-group input').forEach(input => input.style.borderColor = '#e0e0e0');
            document.getElementById('mensajeError').style.display = 'none';
        }
    </script>
</body>
</html>